name: Build and push to gcr
author: etereoio
description: |-
  Build your app docker image and push it to gcr
inputs:
  dockerfilePath:
    description: 'Path to the docker file of your application'
    required: false
    default: 'Dockerfile'
  dockerImageUrl:
    description: 'Url of the docker image'
    required: true
    default: ''
  dockerImageTag:
    description: 'Docker image tag'
    required: false
    default: $GITHUB_SHA
  gcpProjectId:
    description: 'Project id where the kubernetes cluster is located'
    required: true
    default: ''
  gcpServiceAccountKey:
    description: 'Gcp service account key to use for authentication against gcp'
    required: true
    default: ''
outputs:
  sum: # id of the output
    description: 'The sum of the inputs'
runs:
  using: "composite"
  steps:
    - uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
      with:
        project_id: ${{ inputs.gcpProjectId }}
        service_account_key: ${{ inputs.gcpServiceAccountKey }}
        export_default_credentials: true
    - name: Build and push docker image
      run: |-
        docker build . -f ${{ inputs.dockerfilePath }} -t ${{ inputs.dockerImageUrl }}
        docker tag ${{ inputs.dockerImageUrl }} ${{ inputs.dockerImageUrl }}:${{ inputs.dockerImageTag }}
        docker push -t ${{ inputs.dockerImageUrl }}:${{ inputs.dockerImageTag }}